<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1920 1400" width="1920" height="1400">
  <defs>
    <linearGradient id="gatewayBg" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#1a1a2e"/>
      <stop offset="100%" style="stop-color:#16213e"/>
    </linearGradient>
    <linearGradient id="mimirBg" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#0f3460"/>
      <stop offset="100%" style="stop-color:#16213e"/>
    </linearGradient>
    <linearGradient id="saoBg" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#533483"/>
      <stop offset="100%" style="stop-color:#2d1b4e"/>
    </linearGradient>
    <linearGradient id="chronosBg" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#0d7377"/>
      <stop offset="100%" style="stop-color:#0a4d50"/>
    </linearGradient>
    <filter id="shadow" x="-4%" y="-4%" width="108%" height="108%">
      <feDropShadow dx="0" dy="4" stdDeviation="6" flood-opacity="0.25"/>
    </filter>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#e94560"/>
    </marker>
  </defs>
  <rect width="1920" height="1400" fill="#0f0f1a"/>
  <text x="960" y="52" text-anchor="middle" font-family="system-ui, sans-serif" font-size="32" font-weight="700" fill="#eee">PAGI Mimir + SAO Redaction + Chronos - High-Level Flow</text>
  <text x="960" y="82" text-anchor="middle" font-family="system-ui, sans-serif" font-size="16" fill="#888">Bare-Metal Gateway - Meeting Minutes - Protected Terms</text>

  <!-- Gateway / API -->
  <g filter="url(#shadow)">
    <rect x="720" y="100" width="480" height="120" rx="12" fill="url(#gatewayBg)" stroke="#e94560" stroke-width="2"/>
    <text x="960" y="142" text-anchor="middle" font-family="system-ui, sans-serif" font-size="20" font-weight="600" fill="#fff">pagi-gateway</text>
    <text x="960" y="168" text-anchor="middle" font-family="system-ui, sans-serif" font-size="14" fill="#aaa">POST /api/v1/mimir/start - POST /api/v1/mimir/stop</text>
    <text x="960" y="198" text-anchor="middle" font-family="system-ui, sans-serif" font-size="12" fill="#888">Pre-flight audio - MeetingStorage - Chronos thread create</text>
  </g>

  <!-- Mimir Start flow -->
  <g>
    <rect x="80" y="280" width="380" height="320" rx="12" fill="url(#mimirBg)" stroke="#e94560" stroke-width="1.5" opacity="0.95"/>
    <text x="270" y="312" text-anchor="middle" font-family="system-ui, sans-serif" font-size="18" font-weight="600" fill="#fff">Mimir Start</text>
    <line x1="100" y1="328" x2="440" y2="328" stroke="#e94560" stroke-width="1"/>
    <text x="100" y="358" font-family="system-ui, sans-serif" font-size="13" fill="#ddd">1. Pre-flight audio (mic/loopback)</text>
    <text x="100" y="388" font-family="system-ui, sans-serif" font-size="13" fill="#ddd">2. Create meeting in meetings table</text>
    <text x="100" y="418" font-family="system-ui, sans-serif" font-size="13" fill="#ddd">3. Chronos thread: Meeting: date time</text>
    <text x="100" y="448" font-family="system-ui, sans-serif" font-size="13" fill="#ddd">4. MeetingRecorder (cpal) + buffer</text>
    <text x="100" y="478" font-family="system-ui, sans-serif" font-size="13" fill="#ddd">5. WhisperTranscriptWorker (15s)</text>
    <text x="100" y="508" font-family="system-ui, sans-serif" font-size="13" fill="#ddd">6. segment_pump -&gt; Chronos messages</text>
    <text x="100" y="538" font-family="system-ui, sans-serif" font-size="13" fill="#ddd">   (role: assistant, source: mimir)</text>
    <text x="100" y="578" font-family="system-ui, sans-serif" font-size="12" fill="#888">Returns: meeting_id, thread_id, project_id</text>
  </g>

  <!-- Recording / transcripts -->
  <g>
    <rect x="520" y="340" width="280" height="100" rx="10" fill="#1a1a2e" stroke="#0d7377" stroke-width="1.5"/>
    <text x="660" y="372" text-anchor="middle" font-family="system-ui, sans-serif" font-size="14" font-weight="600" fill="#0d7377">meeting_transcripts</text>
    <text x="660" y="398" text-anchor="middle" font-family="system-ui, sans-serif" font-size="12" fill="#aaa">(id, meeting_id, text, timestamp_sec)</text>
    <text x="660" y="424" text-anchor="middle" font-family="system-ui, sans-serif" font-size="11" fill="#666">Raw segments from Whisper STT</text>
  </g>

  <!-- Mimir Stop + SAO Redaction -->
  <g>
    <rect x="880" y="280" width="520" height="400" rx="12" fill="url(#saoBg)" stroke="#a855f7" stroke-width="1.5" opacity="0.95"/>
    <text x="1140" y="312" text-anchor="middle" font-family="system-ui, sans-serif" font-size="18" font-weight="600" fill="#fff">Mimir Stop + SAO Redaction</text>
    <line x1="900" y1="328" x2="1380" y2="328" stroke="#a855f7" stroke-width="1"/>
    <text x="900" y="358" font-family="system-ui, sans-serif" font-size="13" fill="#ddd">1. Stop worker; list_transcripts()</text>
    <text x="900" y="388" font-family="system-ui, sans-serif" font-size="13" fill="#ddd">2. Build transcript_body (bullets with timestamps)</text>
    <text x="900" y="418" font-family="system-ui, sans-serif" font-size="13" fill="#e0b3ff">3. SAORedactor::load_from_data_dir(data_dir)</text>
    <text x="900" y="448" font-family="system-ui, sans-serif" font-size="12" fill="#aaa">   - data/protected_terms.txt (e.g. VANGUARD)</text>
    <text x="900" y="478" font-family="system-ui, sans-serif" font-size="13" fill="#e0b3ff">4. If project folder has .sao_policy - merge_terms_from_path()</text>
    <text x="900" y="508" font-family="system-ui, sans-serif" font-size="13" fill="#e0b3ff">5. sanitize_transcript(transcript_body)</text>
    <text x="900" y="538" font-family="system-ui, sans-serif" font-size="12" fill="#aaa">   - replace protected terms with [PROTECTED_TERM]</text>
    <text x="900" y="568" font-family="system-ui, sans-serif" font-size="13" fill="#ddd">6. summary_md = title + sanitized transcript</text>
    <text x="900" y="598" font-family="system-ui, sans-serif" font-size="13" fill="#ddd">7. Write meeting_YYYYMMDD_HHMM.md - project folder</text>
    <text x="900" y="628" font-family="system-ui, sans-serif" font-size="13" fill="#ddd">8. end_meeting(); rename Chronos thread (heuristic title)</text>
    <text x="900" y="658" font-family="system-ui, sans-serif" font-size="12" fill="#888">Returns: meeting_id, thread_id, summary_path</text>
  </g>

  <!-- pagi-core SAO Redaction -->
  <g>
    <rect x="1440" y="320" width="420" height="220" rx="12" fill="#2d1b4e" stroke="#a855f7" stroke-width="1.5"/>
    <text x="1650" y="352" text-anchor="middle" font-family="system-ui, sans-serif" font-size="16" font-weight="600" fill="#e0b3ff">pagi-core::security::redaction</text>
    <line x1="1460" y1="368" x2="1840" y2="368" stroke="#a855f7" stroke-width="1"/>
    <text x="1460" y="398" font-family="system-ui, sans-serif" font-size="12" fill="#ccc">SAORedactor</text>
    <text x="1460" y="428" font-family="system-ui, sans-serif" font-size="11" fill="#aaa">- load_from_path / load_from_data_dir</text>
    <text x="1460" y="448" font-family="system-ui, sans-serif" font-size="11" fill="#aaa">- merge_terms_from_path (.sao_policy)</text>
    <text x="1460" y="468" font-family="system-ui, sans-serif" font-size="11" fill="#aaa">- sanitize_transcript(text) -&gt; [PROTECTED_TERM]</text>
    <text x="1460" y="498" font-family="system-ui, sans-serif" font-size="11" fill="#aaa">- Regex: case-insensitive, word boundaries</text>
    <text x="1460" y="528" font-family="system-ui, sans-serif" font-size="11" fill="#888">File format: one term per line; # comments ignored</text>
  </g>

  <!-- Chronos (KB-04) -->
  <g>
    <rect x="80" y="680" width="520" height="320" rx="12" fill="url(#chronosBg)" stroke="#14ffec" stroke-width="1.5" opacity="0.95"/>
    <text x="340" y="712" text-anchor="middle" font-family="system-ui, sans-serif" font-size="18" font-weight="600" fill="#fff">Chronos (KB-04) - chronos.sqlite</text>
    <line x1="100" y1="728" x2="580" y2="728" stroke="#14ffec" stroke-width="1"/>
    <text x="100" y="758" font-family="system-ui, sans-serif" font-size="13" fill="#b8f5f5">projects (id, name)</text>
    <text x="100" y="788" font-family="system-ui, sans-serif" font-size="13" fill="#b8f5f5">threads (id, project_id, title, last_message_at_ms)</text>
    <text x="100" y="818" font-family="system-ui, sans-serif" font-size="13" fill="#b8f5f5">messages (id, thread_id, role, content, metadata)</text>
    <text x="100" y="858" font-family="system-ui, sans-serif" font-size="12" fill="#888">meetings + meeting_transcripts (Mimir tables same DB)</text>
    <text x="100" y="898" font-family="system-ui, sans-serif" font-size="12" fill="#14ffec">Live transcript segments -&gt; messages (role: assistant)</text>
    <text x="100" y="938" font-family="system-ui, sans-serif" font-size="12" fill="#14ffec">Stop: thread renamed to heuristic title (e.g. ALLCAPS token)</text>
  </g>

  <!-- Studio UI -->
  <g>
    <rect x="660" y="740" width="400" height="240" rx="12" fill="#1a1a2e" stroke="#14ffec" stroke-width="1.5"/>
    <text x="860" y="772" text-anchor="middle" font-family="system-ui, sans-serif" font-size="16" font-weight="600" fill="#fff">Studio UI (pagi-studio-ui)</text>
    <line x1="680" y1="788" x2="1040" y2="788" stroke="#14ffec" stroke-width="1"/>
    <text x="680" y="818" font-family="system-ui, sans-serif" font-size="12" fill="#aaa">Record Meeting -&gt; mimir/start -&gt; setActiveThread(thread_id)</text>
    <text x="680" y="848" font-family="system-ui, sans-serif" font-size="12" fill="#aaa">ChatStore sync (8s) loads Chronos messages</text>
    <text x="680" y="878" font-family="system-ui, sans-serif" font-size="12" fill="#aaa">Transcript segments appear live in sidebar</text>
    <text x="680" y="908" font-family="system-ui, sans-serif" font-size="12" fill="#aaa">Stop -&gt; mimir/stop -&gt; summary_path (Markdown)</text>
    <text x="680" y="948" font-family="system-ui, sans-serif" font-size="11" fill="#666">Markdown on disk = redacted ([PROTECTED_TERM])</text>
  </g>

  <!-- Data files -->
  <g>
    <rect x="1120" y="740" width="380" height="260" rx="12" fill="#0f0f1a" stroke="#888" stroke-width="1"/>
    <text x="1310" y="772" text-anchor="middle" font-family="system-ui, sans-serif" font-size="14" font-weight="600" fill="#ccc">Data / Config</text>
    <line x1="1140" y1="788" x2="1480" y2="788" stroke="#555" stroke-width="1"/>
    <text x="1140" y="818" font-family="monospace" font-size="12" fill="#0d7377">data/protected_terms.txt</text>
    <text x="1140" y="848" font-family="system-ui, sans-serif" font-size="11" fill="#666">VANGUARD, ... (one per line)</text>
    <text x="1140" y="878" font-family="monospace" font-size="12" fill="#a855f7">&lt;project_folder&gt;/.sao_policy</text>
    <text x="1140" y="908" font-family="system-ui, sans-serif" font-size="11" fill="#666">Optional extra terms per project</text>
    <text x="1140" y="948" font-family="monospace" font-size="12" fill="#14ffec">data/pagi_chronos/chronos.sqlite</text>
    <text x="1140" y="978" font-family="system-ui, sans-serif" font-size="11" fill="#666">Meetings, transcripts, threads, messages</text>
  </g>

  <!-- Arrows -->
  <path d="M 460 440 L 520 390" stroke="#e94560" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  <path d="M 800 390 L 880 400" stroke="#e94560" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  <path d="M 1360 480 L 1440 430" stroke="#a855f7" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  <path d="M 960 220 L 960 280" stroke="#e94560" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  <path d="M 960 680 L 860 740" stroke="#14ffec" stroke-width="1.5" fill="none" marker-end="url(#arrowhead)"/>
  <path d="M 1380 600 L 1310 740" stroke="#a855f7" stroke-width="1.5" fill="none" marker-end="url(#arrowhead)"/>
  <path d="M 600 620 L 340 680" stroke="#14ffec" stroke-width="1.5" fill="none" marker-end="url(#arrowhead)"/>
</svg>
