<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PAGI XCURZENS — Traveler</title>
  <script src="https://unpkg.com/htmx.org@2.0.4"></script>
  <script src="https://unpkg.com/htmx.org@2.0.4/dist/ext/sse.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            navy: '#051C55',
            orange: '#FA921C',
          },
        },
      },
    };
  </script>
  <style>
    .xcurzens-traveler { color: #051C55; }
    .xcurzens-accent { color: #FA921C; }
  </style>
</head>
<body class="bg-slate-100 min-h-screen flex flex-col">
  <!-- System Status + Scout Context badge (top right) -->
  <header class="flex justify-end items-center gap-3 p-3 flex-wrap">
    <div id="scout-context-badge" class="text-xs font-medium px-2 py-1 rounded" style="color: #051C55; background-color: #FA921C; display: none;">
      Scout Context: <span id="context-city">—</span> | <span id="context-weather">—</span>
    </div>
    <div id="system-status" class="text-sm font-medium text-navy" data-status="checking">
      <span class="text-slate-500">Checking…</span>
    </div>
  </header>

  <!-- Scout Console (chat display) -->
  <main class="flex-1 overflow-y-auto p-4">
    <div
      id="scout-console"
      class="max-w-3xl mx-auto space-y-3 min-h-[200px] rounded-lg p-4"
      style="background-color: #051C55; color: #e2e8f0;"
      role="log"
      aria-label="Scout responses"
    >
      <p class="text-slate-400 text-sm">Scout console — ask anything. Responses stream here.</p>
    </div>
  </main>

  <!-- Command Bar (fixed bottom) -->
  <footer class="sticky bottom-0 p-4 rounded-t-lg shadow-lg" style="background-color: #051C55;">
    <form id="command-form" class="max-w-3xl mx-auto flex gap-2">
      <input
        type="text"
        id="query"
        name="query"
        placeholder="Ask the Scout…"
        autocomplete="off"
        class="flex-1 px-4 py-3 rounded-lg border border-slate-600 bg-slate-800 text-white placeholder-slate-400 focus:ring-2 focus:ring-orange focus:border-transparent outline-none"
        style="background-color: rgba(30,41,59,0.9); border-color: #475569;"
      />
      <button
        type="submit"
        class="px-6 py-3 rounded-lg font-semibold text-navy transition hover:opacity-90 focus:ring-2 focus:ring-offset-2 focus:ring-offset-navy focus:ring-orange outline-none"
        style="background-color: #FA921C; color: #051C55;"
      >
        Send
      </button>
    </form>
  </footer>

  <script>
    (function () {
      console.log("[XCURZENS UI] Command Bar Synchronized with Jamey's Infrastructure.");

      // Global geo-context: injected into every Scout POST
      var geoContext = { city: null, weather: null };

      function updateContextBadge() {
        var badge = document.getElementById('scout-context-badge');
        var cityEl = document.getElementById('context-city');
        var weatherEl = document.getElementById('context-weather');
        cityEl.textContent = geoContext.city || '—';
        weatherEl.textContent = geoContext.weather || '—';
        badge.style.display = (geoContext.city || geoContext.weather) ? 'inline-block' : 'none';
      }

      // Reverse geocode: coords -> city name (Nominatim)
      function getCityFromCoords(lat, lon) {
        var url = 'https://nominatim.openstreetmap.org/reverse?lat=' + lat + '&lon=' + lon + '&format=json';
        return fetch(url, { headers: { 'Accept': 'application/json', 'User-Agent': 'PAGI-XCURZENS-Traveler/1.0' } })
          .then(function (r) { return r.json(); })
          .then(function (data) {
            var city = (data.address && (data.address.city || data.address.town || data.address.village || data.address.county)) || data.name || 'Unknown';
            return city;
          })
          .catch(function () { return null; });
      }

      // Weather: Open-Meteo (free, no key). Returns e.g. "Sunny, 72°F"
      function getWeather(lat, lon) {
        var url = 'https://api.open-meteo.com/v1/forecast?latitude=' + lat + '&longitude=' + lon + '&current=temperature_2m,weather_code&temperature_unit=fahrenheit';
        return fetch(url)
          .then(function (r) { return r.json(); })
          .then(function (data) {
            var cur = data.current;
            if (!cur) return null;
            var temp = cur.temperature_2m != null ? Math.round(cur.temperature_2m) + '°F' : '';
            var code = cur.weather_code || 0;
            var conditions = { 0: 'Clear', 1: 'Mainly clear', 2: 'Partly cloudy', 3: 'Overcast', 45: 'Foggy', 48: 'Fog', 51: 'Light drizzle', 61: 'Rain', 63: 'Rain', 65: 'Heavy rain', 71: 'Snow', 80: 'Showers', 95: 'Thunderstorm', 96: 'Thunderstorm' };
            var cond = conditions[code] || 'Conditions ' + code;
            var weather = cond + (temp ? ', ' + temp : '');
            console.log("[XCURZENS SYSTEM] Weather bandwidth received for Jamey's Infrastructure: " + weather);
            return weather;
          })
          .catch(function () { return null; });
      }

      // Silent sync on load: geolocation -> city + weather -> geoContext
      function syncGeoContext() {
        if (!navigator.geolocation) {
          updateContextBadge();
          return;
        }
        navigator.geolocation.getCurrentPosition(
          function (pos) {
            var lat = pos.coords.latitude;
            var lon = pos.coords.longitude;
            Promise.all([getCityFromCoords(lat, lon), getWeather(lat, lon)])
              .then(function (res) {
                geoContext.city = res[0];
                geoContext.weather = res[1];
                updateContextBadge();
                console.log("[XCURZENS SYSTEM] Geo-Context Synchronized for Jamey's Infrastructure.");
              })
              .catch(function () {
                geoContext.city = null;
                geoContext.weather = null;
                updateContextBadge();
              });
          },
          function () {
            updateContextBadge();
          },
          { enableHighAccuracy: false, timeout: 10000, maximumAge: 300000 }
        );
      }
      syncGeoContext();

      var form = document.getElementById('command-form');
      var queryInput = document.getElementById('query');
      var consoleEl = document.getElementById('scout-console');

      form.addEventListener('submit', function (e) {
        e.preventDefault();
        var q = queryInput.value.trim();
        if (!q) return;

        queryInput.value = '';

        var body = { query: q, city: geoContext.city, weather: geoContext.weather };

        fetch('/api/v1/scout', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        })
          .then(function (res) { return res.text(); })
          .then(function (text) {
            var lines = text.split('\n');
            var data = lines
              .filter(function (l) { return l.indexOf('data: ') === 0; })
              .map(function (l) { return l.slice(6); })
              .join('');
            if (data) {
              var wrap = document.createElement('div');
              wrap.className = 'mb-3';
              wrap.innerHTML = data;
              consoleEl.appendChild(wrap);
              consoleEl.scrollTop = consoleEl.scrollHeight;
            }
          })
          .catch(function (err) {
            console.error("[XCURZENS UI] Scout request failed", err);
            var errDiv = document.createElement('div');
            errDiv.className = 'text-orange text-sm';
            errDiv.textContent = 'Scout unavailable. Check connection.';
            consoleEl.appendChild(errDiv);
          });
      });

      // System Status: ping /health every 30s, show "Bandwidth Stable" in Orange
      var statusEl = document.getElementById('system-status');
      function checkHealth() {
        fetch('/health')
          .then(function (r) {
            if (r.ok) {
              statusEl.innerHTML = '<span style="color: #FA921C;">Bandwidth Stable</span>';
              statusEl.setAttribute('data-status', 'ok');
            } else {
              statusEl.innerHTML = '<span class="text-red-400">Unstable</span>';
              statusEl.setAttribute('data-status', 'error');
            }
          })
          .catch(function () {
            statusEl.innerHTML = '<span class="text-red-400">Offline</span>';
            statusEl.setAttribute('data-status', 'error');
          });
      }
      checkHealth();
      setInterval(checkHealth, 30000);
    })();
  </script>
</body>
</html>
